<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Control del Hogar</title>
    <!-- Incluye Tailwind CSS para un estilo rápido y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }
        .task-card, .note-card { /* Añadido .note-card */
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
            border-left: 8px solid;
        }
        .task-card:hover, .note-card:hover { /* Añadido .note-card */
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }
        /* Colores de borde para categorías de tareas */
        .category-baño { border-left-color: #4dc0b5; } /* Teal */
        .category-suelo { border-left-color: #9f7aea; } /* Purple */
        .category-cocina { border-left-color: #f6ad55; } /* Orange */
        .category-dormitorio { border-left-color: #3b82f6; } /* Blue */
        .category-general { border-left-color: #ef4444; } /* Red */
        .category-pasillo { border-left-color: #6b7280; } /* Gray */
        .category-balcón { border-left-color: #10b981; } /* Green */
        .category-otro { border-left-color: #a855f7; } /* Violet */

        /* Colores de borde para tipos de notas */
        .note-type-text { border-left-color: #2563eb; } /* Blue */
        .note-type-recipe { border-left-color: #9333ea; } /* Purple */
        .note-type-file { border-left-color: #d97706; } /* Amber */


        .completed-task {
            text-decoration: line-through;
            opacity: 0.6;
            background-color: #e2e8f0;
        }
        .add-task-btn, .add-note-btn { /* Añadido .add-note-btn */
            background: linear-gradient(to right, #6366f1, #8b5cf6);
            box-shadow: 0 4px 14px rgba(99, 102, 241, 0.3);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .add-task-btn:hover, .add-note-btn:hover { /* Añadido .add-note-btn */
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
        }
        .nav-icon {
            color: #6b7280;
            transition: color 0.2s;
        }
        .nav-icon.active {
            color: #4f46e5;
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000; /* Asegurar que el modal esté por encima de todo */
        }
        .modal-content {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        input, select, textarea {
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
        }
        /* Estilos para el campo de entrada de archivo */
        input[type="file"] {
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            background-color: #f9fafb;
            cursor: pointer;
        }
        input[type="file"]::file-selector-button {
            background-color: #6366f1;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            margin-right: 1rem;
            transition: background-color 0.2s ease-in-out;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: #4f46e5;
        }
        #appMessage {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            color: white;
            font-weight: 600;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        #appMessage.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        #appMessage.error {
            background-color: #ef4444; /* Red-500 */
        }
        #appMessage.success {
            background-color: #22c55e; /* Green-500 */
        }

        /* Calendar specific styles */
        #calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background-color: #e2e8f0; /* Light gray for grid lines */
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        .calendar-header-day {
            background-color: #cbd5e0; /* Gray-300 */
            font-weight: 600;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.875rem; /* sm text */
        }
        .calendar-day-cell {
            background-color: white;
            padding: 0.75rem;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            position: relative;
        }
        .calendar-day-cell:hover {
            background-color: #f0f4f8; /* Lighter on hover */
        }
        .calendar-day-cell.inactive {
            background-color: #f8fafc; /* Lighter background for inactive days */
            color: #cbd5e0; /* Lighter text for inactive days */
            cursor: default;
        }
        .calendar-day-cell.today {
            border: 2px solid #4f46e5; /* Indigo-600 */
            box-shadow: 0 0 0 1px #4f46e5;
        }
        .calendar-day-cell .day-number {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }
        .calendar-day-cell .task-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #f6ad55; /* Orange-400 for tasks */
            margin-top: 0.25rem;
            position: absolute; /* Position indicator */
            top: 0.5rem;
            right: 0.5rem;
        }
        .calendar-day-cell .task-count {
            font-size: 0.75rem;
            background-color: #10b981; /* Green-500 */
            color: white;
            border-radius: 9999px; /* Full rounded */
            padding: 0.1rem 0.4rem;
            position: absolute;
            bottom: 0.5rem;
            right: 0.5rem;
            font-weight: 600;
        }
        /* Modal for day tasks */
        #dayTasksModalContent ul {
            list-style: none;
            padding: 0;
        }
        #dayTasksModalContent ul li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
            font-size: 0.95rem;
        }
        #dayTasksModalContent ul li:last-child {
            border-bottom: none;
        }
        #dayTasksModalContent ul li .task-due {
            font-size: 0.8rem;
            color: #6b7280;
        }

        /* Progress Bar */
        .progress-bar-container {
            width: 100%;
            background-color: #e5e7eb; /* Gray-200 */
            border-radius: 9999px; /* Full rounded */
            height: 1.5rem;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #22c55e; /* Green-500 */
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header (Pestañas de Navegación) -->
    <header class="bg-white shadow-sm p-4 flex justify-around items-center sticky top-0 z-10">
        <nav class="flex space-x-6">
            <button class="nav-item flex flex-col items-center text-sm font-medium text-gray-700 hover:text-indigo-600 active-nav-tab" data-tab="today">
                <i class="fas fa-home text-2xl nav-icon active"></i>
                <span>Hoy</span>
            </button>
            <button class="nav-item flex flex-col items-center text-sm font-medium text-gray-700 hover:text-indigo-600" data-tab="pending">
                <i class="fas fa-clipboard-list text-2xl nav-icon"></i>
                <span>Pendientes</span>
            </button>
            <button class="nav-item flex flex-col items-center text-sm font-medium text-gray-700 hover:text-indigo-600" data-tab="calendar">
                <i class="fas fa-calendar-alt text-2xl nav-icon"></i>
                <span>Calendario</span>
            </button>
            <button class="nav-item flex flex-col items-center text-sm font-medium text-gray-700 hover:text-indigo-600" data-tab="notes">
                <i class="fas fa-book text-2xl nav-icon"></i>
                <span>Notas</span>
            </button>
            <button class="nav-item flex flex-col items-center text-sm font-medium text-gray-700 hover:text-indigo-600" data-tab="progress">
                <i class="fas fa-chart-line text-2xl nav-icon"></i>
                <span>Progreso</span>
            </button>
            <button class="nav-item flex flex-col items-center text-sm font-medium text-gray-700 hover:text-indigo-600" data-tab="history">
                <i class="fas fa-history text-2xl nav-icon"></i>
                <span>Historial</span>
            </button>
        </nav>
    </header>

    <!-- Global App Message Display -->
    <div id="appMessage" class="hidden"></div>


    <!-- Main Content Area -->
    <main class="flex-grow p-6">

        <!-- Sección "Hoy" (Tareas de Limpieza) -->
        <section id="today" class="tab-content active-tab">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Tareas de Limpieza</h1>
            <div id="taskList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Las tareas se cargarán aquí dinámicamente -->
            </div>
            <div class="fixed bottom-24 right-6 md:right-10 lg:right-16">
                <button id="addTaskBtn" class="add-task-btn text-white font-semibold py-4 px-6 rounded-full shadow-lg flex items-center space-x-2">
                    <i class="fas fa-plus text-xl"></i>
                    <span>Añadir tarea</span>
                </button>
            </div>
        </section>

        <!-- Sección "Pendientes" (Tareas no completadas) -->
        <section id="pending" class="tab-content hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Tareas Pendientes</h1>
            <div id="pendingTaskList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Las tareas pendientes se cargarán aquí dinámicamente -->
            </div>
        </section>

        <!-- Sección "Calendario" -->
        <section id="calendar" class="tab-content hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Calendario de Tareas</h1>
            <div class="bg-white rounded-2xl shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <button id="prevMonthBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white p-2 rounded-full"><i class="fas fa-chevron-left"></i></button>
                    <h2 id="currentMonthYear" class="text-2xl font-semibold text-gray-800"></h2>
                    <button id="nextMonthBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white p-2 rounded-full"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div id="calendar-grid">
                    <!-- Calendar days will be rendered here -->
                </div>
            </div>
        </section>

        <!-- Sección "Notas" (Repositorio de Notas unificadas) -->
        <section id="notes" class="tab-content hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Mis Notas</h1>
            <div class="mb-6">
                <input type="text" id="noteSearch" placeholder="Buscar notas por título o contenido..." class="w-full p-3 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div id="noteList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Las notas se cargarán aquí dinámicamente -->
            </div>
            <div class="fixed bottom-24 right-6 md:right-10 lg:right-16">
                <button id="addNoteBtn" class="add-note-btn text-white font-semibold py-4 px-6 rounded-full shadow-lg flex items-center space-x-2">
                    <i class="fas fa-plus text-xl"></i>
                    <span>Añadir nota</span>
                </button>
            </div>
        </section>

        <!-- Sección "Progreso" -->
        <section id="progress" class="tab-content hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Mi Progreso</h1>
            <div class="bg-white rounded-2xl shadow-md p-6 text-center space-y-6">
                <h2 class="text-2xl font-semibold text-gray-700">Resumen de Tareas Completadas</h2>
                <div>
                    <p class="text-lg text-gray-600">Total de tareas creadas: <span id="totalTasksCreated" class="font-bold text-indigo-600">0</span></p>
                    <p class="text-lg text-gray-600">Tareas completadas: <span id="totalTasksCompleted" class="font-bold text-green-600">0</span></p>
                </div>

                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Porcentaje de Completación</h3>
                    <div class="progress-bar-container">
                        <div id="completionProgressBar" class="progress-bar-fill" style="width: 0%;">0%</div>
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Mensaje Motivacional</h3>
                    <p id="motivationalMessage" class="text-gray-700 italic text-base">¡Vamos a empezar a organizar tu hogar!</p>
                </div>
            </div>
        </section>

        <!-- Sección "Historial" (Tareas completadas) -->
        <section id="history" class="tab-content hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Historial de Tareas</h1>
            <div id="historyTaskList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Las tareas completadas se cargarán aquí dinámicamente -->
            </div>
        </section>

    </main>

    <!-- Modal para Añadir/Editar Tarea de Limpieza -->
    <div id="taskModal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-lg p-6 space-y-4">
            <h2 id="taskModalTitle" class="text-2xl font-bold text-gray-800 mb-4">Añadir Nueva Tarea</h2>
            <input type="hidden" id="taskId">
            <div>
                <label for="taskName" class="block text-gray-700 font-medium mb-2">Nombre de la Tarea</label>
                <input type="text" id="taskName" placeholder="Ej: Limpiar el baño" class="focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="taskDescription" class="block text-gray-700 font-medium mb-2">Descripción (Opcional)</label>
                <textarea id="taskDescription" rows="2" placeholder="Detalles específicos de la tarea" class="focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>
            <div>
                <label for="taskCategory" class="block text-gray-700 font-medium mb-2">Categoría</label>
                <select id="taskCategory" class="focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="Baño">Baño</option>
                    <option value="Cocina">Cocina</option>
                    <option value="Suelo">Suelo</option>
                    <option value="Dormitorio">Dormitorio</option>
                    <option value="General">General</option>
                    <option value="Pasillo">Pasillo</option>
                    <option value="Balcón">Balcón</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
            <div>
                <label for="taskFrequencyUnit" class="block text-gray-700 font-medium mb-2">Frecuencia</label>
                <div class="flex space-x-2">
                    <input type="number" id="taskFrequencyValue" min="1" value="1" class="w-1/3 focus:ring-indigo-500 focus:border-indigo-500">
                    <select id="taskFrequencyUnit" class="w-2/3 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="days">Días</option>
                        <option value="weeks">Semanas</option>
                        <option value="months">Meses</option>
                        <option value="years">Años</option>
                        <option value="specific_days">Días de la Semana</option>
                    </select>
                </div>
            </div>
            <div id="daysOfWeekSelection" class="mt-4 hidden">
                <label class="block text-gray-700 font-medium mb-2">Selecciona los días:</label>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-sm">
                    <label class="flex items-center">
                        <input type="checkbox" name="daysOfWeek" value="0" class="mr-2 rounded text-indigo-600 focus:ring-indigo-500"> Domingo
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="daysOfWeek" value="1" class="mr-2 rounded text-indigo-600 focus:ring-indigo-500"> Lunes
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="daysOfWeek" value="2" class="mr-2 rounded text-indigo-600 focus:ring-indigo-500"> Martes
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="daysOfWeek" value="3" class="mr-2 rounded text-indigo-600 focus:ring-indigo-500"> Miércoles
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="daysOfWeek" value="4" class="mr-2 rounded text-indigo-600 focus:ring-indigo-500"> Jueves
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="daysOfWeek" value="5" class="mr-2 rounded text-indigo-600 focus:ring-indigo-500"> Viernes
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="daysOfWeek" value="6" class="mr-2 rounded text-indigo-600 focus:ring-indigo-500"> Sábado
                    </label>
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="cancelTaskBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-xl">Cancelar</button>
                <button id="saveTaskBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-xl">Guardar Tarea</button>
            </div>
        </div>
    </div>

    <!-- Modal para Añadir/Editar Nota General -->
    <div id="noteModal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-lg p-6 space-y-4">
            <h2 id="noteModalTitle" class="text-2xl font-bold text-gray-800 mb-4">Añadir Nueva Nota</h2>
            <input type="hidden" id="noteId">
            <div>
                <label for="noteTitle" class="block text-gray-700 font-medium mb-2">Título de la Nota</label>
                <input type="text" id="noteTitle" placeholder="Ej: Lentejas de la abuela / Cambiar filtro de agua" class="focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="noteContent" class="block text-gray-700 font-medium mb-2">Contenido de la Nota</label>
                <textarea id="noteContent" rows="6" placeholder="Pasos para preparar la receta / Detalles de la nota" class="focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
            <div class="mt-4">
                <label for="noteFile" class="block text-gray-700 font-medium mb-2">Adjuntar Archivo (Opcional)</label>
                <input type="file" id="noteFile" class="focus:ring-blue-500 focus:border-blue-500">
                <p class="text-red-500 text-xs mt-1">
                    Advertencia: Los archivos se guardan localmente en tu navegador.
                    Evita adjuntar archivos grandes (max ~5MB total).
                </p>
                <div id="currentAttachedFile" class="mt-2 text-sm text-gray-600 hidden">
                    Archivo actual: <span id="attachedFileName" class="font-medium"></span>
                    <button id="removeAttachedFile" class="text-red-500 hover:text-red-700 ml-2"><i class="fas fa-times-circle"></i> Eliminar</button>
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="cancelNoteBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-xl">Cancelar</button>
                <button id="saveNoteBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-xl">Guardar Nota</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación Personalizado -->
    <div id="confirmModal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-sm p-6 space-y-4 text-center">
            <p id="confirmMessage" class="text-lg font-medium text-gray-700"></p>
            <div class="flex justify-center space-x-4 mt-6">
                <button id="confirmCancelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-xl">Cancelar</button>
                <button id="confirmOkBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-xl">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal para mostrar tareas del día en el calendario -->
    <div id="dayTasksModal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-md p-6 space-y-4">
            <h2 id="dayTasksModalTitle" class="text-2xl font-bold text-gray-800 mb-4">Tareas para [Fecha]</h2>
            <ul id="dayTasksModalContent" class="max-h-80 overflow-y-auto">
                <!-- Tasks will be listed here -->
            </ul>
            <div class="flex justify-end mt-4">
                <button id="closeDayTasksModalBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-xl">Cerrar</button>
            </div>
        </div>
    </div>


    <script>
        // Funciones de utilidad para manejar el almacenamiento local
        const storageKey = 'houseControlApp'; // Clave principal para localStorage
        const appMessageDiv = document.getElementById('appMessage');
        let messageTimeout;

        // Muestra un mensaje temporal en la parte superior de la pantalla
        function showMessage(message, type = 'error', duration = 3000) {
            clearTimeout(messageTimeout);
            appMessageDiv.textContent = message;
            appMessageDiv.className = ``; // Reset classes
            appMessageDiv.classList.add('show', type); // Add type class for styling (error/success)
            appMessageDiv.classList.remove('hidden'); // Ensure it's visible

            messageTimeout = setTimeout(() => {
                appMessageDiv.classList.remove('show');
                appMessageDiv.classList.add('hidden'); // Hide after transition
            }, duration);
        }

        // Carga los datos de localStorage
        function loadData() {
            const data = localStorage.getItem(storageKey);
            return data ? JSON.parse(data) : {
                tasks: [],
                notes: [] // Ahora unificado
            };
        }

        // Guarda los datos en localStorage
        function saveData(data) {
            localStorage.setItem(storageKey, JSON.stringify(data));
        }

        let appData = loadData(); // Carga los datos al iniciar la aplicación

        // --- Gestión de Tareas de Limpieza ---

        // Función para renderizar una tarea individual
        function renderTask(task) {
            const now = new Date();
            const lastCompleted = task.lastCompleted ? new Date(task.lastCompleted) : null;
            let nextDueDate = null;

            if (task.frequencyUnit === 'specific_days' && task.daysOfWeek && task.daysOfWeek.length > 0) {
                // Calculate next due date based on selected days of the week
                let currentSearchDate = lastCompleted ? new Date(lastCompleted) : new Date(now);
                if (lastCompleted) {
                    currentSearchDate.setDate(currentSearchDate.getDate() + 1); // Start searching from the day after last completed
                }

                let foundNextDay = false;
                for (let i = 0; i < 14; i++) { // Check up to 14 days to ensure we find a next day
                    const dayOfWeek = currentSearchDate.getDay(); // 0 = Sunday, 6 = Saturday
                    if (task.daysOfWeek.includes(String(dayOfWeek))) { // daysOfWeek stores strings
                        nextDueDate = new Date(currentSearchDate);
                        foundNextDay = true;
                        break;
                    }
                    currentSearchDate.setDate(currentSearchDate.getDate() + 1);
                }

                if (!foundNextDay) { // Fallback if no day found in the loop
                    let tempDate = lastCompleted ? new Date(lastCompleted) : new Date(now);
                    tempDate.setDate(tempDate.getDate() + 1); // Start from next day
                    for(let i = 0; i < 7; i++) { // Search for the next valid day within 7 days
                        const dayToCheck = (tempDate.getDay() + i) % 7;
                        if (task.daysOfWeek.includes(String(dayToCheck))) {
                            nextDueDate = new Date(tempDate);
                            nextDueDate.setDate(tempDate.getDate() + i);
                            break;
                        }
                    }
                }

            } else if (lastCompleted) {
                // Original frequency logic (days, weeks, months, years)
                nextDueDate = new Date(lastCompleted);
                if (task.frequencyUnit === 'days') {
                    nextDueDate.setDate(nextDueDate.getDate() + task.frequencyValue);
                } else if (task.frequencyUnit === 'weeks') {
                    nextDueDate.setDate(nextDueDate.getDate() + (task.frequencyValue * 7));
                } else if (task.frequencyUnit === 'months') {
                    nextDueDate.setMonth(nextDueDate.getMonth() + task.frequencyValue);
                } else if (task.frequencyUnit === 'years') {
                    nextDueDate.setFullYear(nextDueDate.getFullYear() + task.frequencyValue);
                }
            } else {
                nextDueDate = now; // If never completed, consider it due "today"
            }

            // Apply postponement if exists and is later than the calculated nextDueDate
            if (task.postponeUntilDate) {
                const postponeDate = new Date(task.postponeUntilDate);
                if (postponeDate > nextDueDate) {
                    nextDueDate = postponeDate;
                }
            }


            const isDueToday = nextDueDate && nextDueDate.toDateString() === now.toDateString() && !task.isCompleted;
            const isOverdue = nextDueDate && nextDueDate < now && !task.isCompleted;
            const isCompleted = task.isCompleted;

            let statusText = '';
            let cardClasses = `task-card p-6 flex items-center space-x-4 ${isCompleted ? 'completed-task' : ''} category-${task.category.toLowerCase().replace(/\s/g, '')}`;

            if (isCompleted) {
                statusText = `Completada: ${formatDate(new Date(task.lastCompleted))}`;
                cardClasses = `task-card p-6 flex items-center space-x-4 completed-task category-${task.category.toLowerCase().replace(/\s/g, '')}`;
            } else if (isDueToday) {
                statusText = 'Vence Hoy';
                cardClasses = `task-card p-6 flex items-center space-x-4 border-l-8 border-red-500 category-${task.category.toLowerCase().replace(/\s/g, '')}`;
            } else if (isOverdue) {
                statusText = `Atrasada: ${formatDate(nextDueDate)}`;
                cardClasses = `task-card p-6 flex items-center space-x-4 border-l-8 border-red-700 category-${task.category.toLowerCase().replace(/\s/g, '')}`;
            } else if (nextDueDate) {
                statusText = `Próxima: ${formatDate(nextDueDate)}`;
            } else {
                statusText = 'Sin fecha';
            }

            const iconClass = getCategoryIcon(task.category);

            return `
                <div class="${cardClasses}" data-id="${task.id}">
                    <div class="text-4xl text-gray-600 ${getCategoryColorClass(task.category)}">
                        <i class="${iconClass}"></i>
                    </div>
                    <div class="flex-grow">
                        <h3 class="text-xl font-semibold">${task.name}</h3>
                        <p class="text-gray-500 text-sm">${task.category}</p>
                        <p class="text-gray-600 text-sm font-medium">${statusText}</p>
                    </div>
                    <div class="flex flex-col space-y-2">
                        ${!isCompleted ? `<button class="complete-btn bg-green-500 hover:bg-green-600 text-white text-xs px-3 py-1 rounded-full"><i class="fas fa-check"></i></button>` : ''}
                        ${!isCompleted ? `<button class="postpone-btn bg-yellow-500 hover:bg-yellow-600 text-white text-xs px-3 py-1 rounded-full"><i class="fas fa-forward"></i></button>` : ''}
                        <button class="edit-task-btn bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded-full"><i class="fas fa-edit"></i></button>
                        <button class="delete-task-btn bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded-full"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        }

        // Obtiene el icono para la categoría
        function getCategoryIcon(category) {
            switch (category) {
                case 'Baño': return 'fas fa-toilet';
                case 'Suelo': return 'fas fa-broom';
                case 'Cocina': return 'fas fa-utensils';
                case 'Dormitorio': return 'fas fa-bed';
                case 'General': return 'fas fa-house-cleaning';
                case 'Pasillo': return 'fas fa-route';
                case 'Balcón': return 'fas fa-wind';
                default: return 'fas fa-tasks';
            }
        }

        // Obtiene la clase de color para el icono de la categoría
        function getCategoryColorClass(category) {
            switch (category) {
                case 'Baño': return 'text-teal-500';
                case 'Suelo': return 'text-purple-500';
                case 'Cocina': return 'text-orange-500';
                case 'Dormitorio': return 'text-blue-500';
                case 'General': return 'text-red-500';
                case 'Pasillo': return 'text-gray-500';
                case 'Balcón': return 'text-green-500';
                default: return 'text-indigo-500';
            }
        }

        // Formatea la fecha para mostrar
        function formatDate(date) {
            return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        // Renderiza todas las tareas en las listas correspondientes
        function renderAllTasks() {
            const taskListDiv = document.getElementById('taskList');
            const pendingTaskListDiv = document.getElementById('pendingTaskList');
            const historyTaskListDiv = document.getElementById('historyTaskList');

            taskListDiv.innerHTML = '';
            pendingTaskListDiv.innerHTML = '';
            historyTaskListDiv.innerHTML = '';

            const now = new Date();
            const todayTasks = [];
            const pendingTasks = [];
            const historyTasks = [];

            appData.tasks.forEach(task => {
                let nextDueDate = null;
                const lastCompleted = task.lastCompleted ? new Date(task.lastCompleted) : null;

                if (task.frequencyUnit === 'specific_days' && task.daysOfWeek && task.daysOfWeek.length > 0) {
                    let currentSearchDate = lastCompleted ? new Date(lastCompleted) : new Date(now);
                     if (lastCompleted) {
                        currentSearchDate.setDate(currentSearchDate.getDate() + 1);
                    }

                    let foundNextDay = false;
                    for (let i = 0; i < 14; i++) {
                        const dayOfWeek = currentSearchDate.getDay();
                        if (task.daysOfWeek.includes(String(dayOfWeek))) {
                            nextDueDate = new Date(currentSearchDate);
                            foundNextDay = true;
                            break;
                        }
                        currentSearchDate.setDate(currentSearchDate.getDate() + 1);
                    }

                    if (!foundNextDay) {
                        let tempDate = lastCompleted ? new Date(lastCompleted) : new Date(now);
                        tempDate.setDate(tempDate.getDate() + 1); // Start from next day
                        for(let i = 0; i < 7; i++) {
                            const dayToCheck = (tempDate.getDay() + i) % 7;
                            if (task.daysOfWeek.includes(String(dayToCheck))) {
                                nextDueDate = new Date(tempDate);
                                nextDueDate.setDate(tempDate.getDate() + i);
                                break;
                            }
                        }
                    }

                } else if (lastCompleted) {
                    nextDueDate = new Date(lastCompleted);
                    if (task.frequencyUnit === 'days') {
                        nextDueDate.setDate(nextDueDate.getDate() + task.frequencyValue);
                    } else if (task.frequencyUnit === 'weeks') {
                        nextDueDate.setDate(nextDueDate.getDate() + (task.frequencyValue * 7));
                    } else if (task.frequencyUnit === 'months') {
                        nextDueDate.setMonth(nextDueDate.getMonth() + task.frequencyValue);
                    } else if (task.frequencyUnit === 'years') {
                        nextDueDate.setFullYear(nextDueDate.getFullYear() + task.frequencyValue);
                    }
                } else {
                    nextDueDate = now;
                }

                // Apply postponement if exists and is later than the calculated nextDueDate
                if (task.postponeUntilDate) {
                    const postponeDate = new Date(task.postponeUntilDate);
                    if (postponeDate > nextDueDate) {
                        nextDueDate = postponeDate;
                    }
                }

                const isDueToday = nextDueDate && nextDueDate.toDateString() === now.toDateString();
                const isOverdue = nextDueDate && nextDueDate < now;

                if (task.isCompleted) {
                    historyTasks.push(task);
                } else if (isDueToday || isOverdue) {
                    todayTasks.push(task);
                } else {
                    pendingTasks.push(task);
                }
            });

            todayTasks.forEach(task => taskListDiv.innerHTML += renderTask(task));
            pendingTasks.forEach(task => pendingTaskListDiv.innerHTML += renderTask(task));
            historyTasks.sort((a, b) => new Date(b.lastCompleted) - new Date(a.lastCompleted));
            historyTasks.forEach(task => historyTaskListDiv.innerHTML += renderTask(task));

            addEventListenersToTaskButtons();
        }

        // Abre el modal de tarea para añadir o editar
        function openTaskModal(task = null) {
            const taskModal = document.getElementById('taskModal');
            const taskIdInput = document.getElementById('taskId');
            const taskNameInput = document.getElementById('taskName');
            const taskDescriptionInput = document.getElementById('taskDescription');
            const taskCategorySelect = document.getElementById('taskCategory');
            const taskFrequencyValueInput = document.getElementById('taskFrequencyValue');
            const taskFrequencyUnitSelect = document.getElementById('taskFrequencyUnit');
            const daysOfWeekSelectionDiv = document.getElementById('daysOfWeekSelection');
            const daysOfWeekCheckboxes = document.querySelectorAll('#daysOfWeekSelection input[type="checkbox"]');
            const taskFrequencyValueInputContainer = taskFrequencyValueInput.closest('div.flex'); // Get the parent div of value and unit select
            const taskModalTitle = document.getElementById('taskModalTitle');


            // Reset form
            taskIdInput.value = '';
            taskNameInput.value = '';
            taskDescriptionInput.value = '';
            taskCategorySelect.value = 'General';
            taskFrequencyValueInput.value = '1';
            taskFrequencyUnitSelect.value = 'weeks';
            daysOfWeekCheckboxes.forEach(checkbox => checkbox.checked = false);


            if (task) {
                taskModalTitle.textContent = 'Editar Tarea';
                taskIdInput.value = task.id;
                taskNameInput.value = task.name;
                taskDescriptionInput.value = task.description || '';
                taskCategorySelect.value = task.category;
                taskFrequencyUnitSelect.value = task.frequencyUnit || 'weeks';


                if (task.frequencyUnit === 'specific_days') {
                    daysOfWeekSelectionDiv.classList.remove('hidden');
                    taskFrequencyValueInputContainer.classList.add('hidden'); // Ocultar input de valor y selector de unidad
                    if (task.daysOfWeek) {
                        task.daysOfWeek.forEach(day => {
                            const checkbox = document.querySelector(`#daysOfWeekSelection input[value="${day}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                } else {
                    daysOfWeekSelectionDiv.classList.add('hidden');
                    taskFrequencyValueInputContainer.classList.remove('hidden'); // Mostrar input de valor y selector de unidad
                    taskFrequencyValueInput.value = task.frequencyValue || 1;
                }

            } else {
                taskModalTitle.textContent = 'Añadir Nueva Tarea';
                daysOfWeekSelectionDiv.classList.add('hidden');
                taskFrequencyValueInputContainer.classList.remove('hidden');
            }
            taskModal.classList.remove('hidden');
        }

        // Cierra el modal de tarea
        function closeTaskModal() {
            document.getElementById('taskModal').classList.add('hidden');
        }

        // Manejar el cambio en la unidad de frecuencia para mostrar/ocultar días de la semana
        document.getElementById('taskFrequencyUnit').addEventListener('change', (e) => {
            const daysOfWeekSelectionDiv = document.getElementById('daysOfWeekSelection');
            const taskFrequencyValueInput = document.getElementById('taskFrequencyValue');
            const taskFrequencyValueInputContainer = taskFrequencyValueInput.closest('div.flex');

            if (e.target.value === 'specific_days') {
                daysOfWeekSelectionDiv.classList.remove('hidden');
                taskFrequencyValueInputContainer.classList.add('hidden');
            } else {
                daysOfWeekSelectionDiv.classList.add('hidden');
                taskFrequencyValueInputContainer.classList.remove('hidden');
                taskFrequencyValueInput.value = '1';
            }
        });

        // Añade/Edita una tarea
        document.getElementById('saveTaskBtn').addEventListener('click', () => {
            const taskId = document.getElementById('taskId').value;
            const taskName = document.getElementById('taskName').value.trim();
            const taskDescription = document.getElementById('taskDescription').value.trim();
            const taskCategory = document.getElementById('taskCategory').value;
            const taskFrequencyUnit = document.getElementById('taskFrequencyUnit').value;

            let taskFrequencyValue = null;
            let daysOfWeek = [];

            if (!taskName) {
                showMessage('El nombre de la tarea no puede estar vacío.', 'error');
                return;
            }

            if (taskFrequencyUnit === 'specific_days') {
                daysOfWeek = Array.from(document.querySelectorAll('#daysOfWeekSelection input[type="checkbox"]:checked'))
                               .map(checkbox => checkbox.value);
                if (daysOfWeek.length === 0) {
                    showMessage('Debes seleccionar al menos un día de la semana para esta frecuencia.', 'error');
                    return;
                }
            } else {
                taskFrequencyValue = parseInt(document.getElementById('taskFrequencyValue').value);
                if (isNaN(taskFrequencyValue) || taskFrequencyValue <= 0) {
                    showMessage('La frecuencia debe ser un número positivo.', 'error');
                    return;
                }
            }


            if (taskId) {
                // Editar tarea existente
                const taskIndex = appData.tasks.findIndex(t => t.id === taskId);
                if (taskIndex > -1) {
                    appData.tasks[taskIndex] = {
                        ...appData.tasks[taskIndex],
                        name: taskName,
                        description: taskDescription,
                        category: taskCategory,
                        frequencyValue: taskFrequencyValue,
                        frequencyUnit: taskFrequencyUnit,
                        daysOfWeek: daysOfWeek
                    };
                }
            } else {
                // Añadir nueva tarea
                const newTask = {
                    id: crypto.randomUUID(),
                    name: taskName,
                    description: taskDescription,
                    category: taskCategory,
                    frequencyValue: taskFrequencyValue,
                    frequencyUnit: taskFrequencyUnit,
                    daysOfWeek: daysOfWeek,
                    lastCompleted: null,
                    isCompleted: false,
                    postponeUntilDate: null // New property for postponement
                };
                appData.tasks.push(newTask);
            }
            saveData(appData);
            renderAllTasks();
            closeTaskModal();
            showMessage('Tarea guardada con éxito.', 'success');
        });

        // Event listener para el botón "Añadir tarea"
        document.getElementById('addTaskBtn').addEventListener('click', () => openTaskModal());
        document.getElementById('cancelTaskBtn').addEventListener('click', closeTaskModal);

        // Añadir event listeners a los botones de las tarjetas de tareas
        function addEventListenersToTaskButtons() {
            document.querySelectorAll('.complete-btn').forEach(button => {
                button.onclick = (e) => {
                    e.stopPropagation();
                    const taskId = e.target.closest('.task-card').dataset.id;
                    const taskIndex = appData.tasks.findIndex(t => t.id === taskId);
                    if (taskIndex > -1) {
                        appData.tasks[taskIndex].lastCompleted = new Date().toISOString();
                        appData.tasks[taskIndex].isCompleted = true;
                        appData.tasks[taskIndex].postponeUntilDate = null; // Clear postponement on completion
                        saveData(appData);
                        renderAllTasks();
                        showMessage('Tarea marcada como completada.', 'success');
                        renderProgress(); // Update progress after completing a task
                    }
                };
            });

            document.querySelectorAll('.postpone-btn').forEach(button => {
                button.onclick = (e) => {
                    e.stopPropagation();
                    const taskId = e.target.closest('.task-card').dataset.id;
                    const taskIndex = appData.tasks.findIndex(t => t.id === taskId);
                    if (taskIndex > -1) {
                        const now = new Date();
                        // Postpone by 1 day from now
                        const postponeDate = new Date(now.getTime() + (24 * 60 * 60 * 1000));
                        appData.tasks[taskIndex].postponeUntilDate = postponeDate.toISOString();
                        saveData(appData);
                        renderAllTasks();
                        showMessage('Tarea pospuesta por 1 día.', 'success');
                    }
                };
            });

            document.querySelectorAll('.edit-task-btn').forEach(button => {
                button.onclick = (e) => {
                    e.stopPropagation();
                    const taskId = e.target.closest('.task-card').dataset.id;
                    const task = appData.tasks.find(t => t.id === taskId);
                    if (task) {
                        openTaskModal(task);
                    }
                };
            });

            document.querySelectorAll('.delete-task-btn').forEach(button => {
                button.onclick = (e) => {
                    e.stopPropagation();
                    const taskId = e.target.closest('.task-card').dataset.id;
                    showConfirmModal('¿Estás seguro de que quieres eliminar esta tarea?', () => {
                        appData.tasks = appData.tasks.filter(t => t.id !== taskId);
                        saveData(appData);
                        renderAllTasks();
                        showMessage('Tarea eliminada.', 'success');
                        renderProgress(); // Update progress after deleting a task
                    });
                };
            });
        }


        // --- Gestión de Notas (Unificado) ---

        // Renderiza una nota individual
        function renderNote(note) {
            let fileContentHtml = '';
            let noteTypeClass = 'note-type-text'; // Default type
            if (note.fileData) {
                noteTypeClass = 'note-type-file';
                if (note.fileType && note.fileType.startsWith('image/')) {
                    fileContentHtml = `<img src="${note.fileData}" alt="Adjunto" class="mt-4 max-w-full h-auto rounded-lg shadow-md">`;
                } else if (note.fileName) {
                    fileContentHtml = `<p class="mt-4 text-sm text-gray-700 font-medium"><i class="fas fa-file"></i> Archivo: ${note.fileName}</p>`;
                }
            }

            return `
                <div class="note-card p-6 rounded-2xl shadow-md border border-gray-200 ${noteTypeClass}" data-id="${note.id}">
                    <h3 class="text-xl font-semibold text-gray-800">${note.title}</h3>
                    <p class="mt-2 text-sm text-gray-700 whitespace-pre-wrap">${note.content}</p>
                    ${fileContentHtml}
                    <div class="flex justify-end space-x-2 mt-4">
                        <button class="edit-note-btn bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded-full"><i class="fas fa-edit"></i></button>
                        <button class="delete-note-btn bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded-full"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        }

        // Renderiza todas las notas (con filtro de búsqueda)
        function renderNotes() {
            const noteListDiv = document.getElementById('noteList');
            const searchTerm = document.getElementById('noteSearch').value.toLowerCase();

            const filteredNotes = appData.notes.filter(note =>
                note.title.toLowerCase().includes(searchTerm) ||
                note.content.toLowerCase().includes(searchTerm)
            );
            noteListDiv.innerHTML = filteredNotes.map(renderNote).join('');
            addEventListenersToNoteButtons();
        }

        // Abre el modal de nota
        function openNoteModal(note = null) {
            const noteModal = document.getElementById('noteModal');
            const noteIdInput = document.getElementById('noteId');
            const noteTitleInput = document.getElementById('noteTitle');
            const noteContentInput = document.getElementById('noteContent');
            const noteFileInput = document.getElementById('noteFile');
            const currentAttachedFileDiv = document.getElementById('currentAttachedFile');
            const attachedFileNameSpan = document.getElementById('attachedFileName');
            const removeAttachedFileBtn = document.getElementById('removeAttachedFile');
            const noteModalTitle = document.getElementById('noteModalTitle');

            noteFileInput.value = ''; // Limpiar input de archivo al abrir modal
            currentAttachedFileDiv.classList.add('hidden'); // Hide attachment info by default
            attachedFileNameSpan.textContent = ''; // Clear file name

            if (note) {
                noteModalTitle.textContent = 'Editar Nota';
                noteIdInput.value = note.id;
                noteTitleInput.value = note.title;
                noteContentInput.value = note.content;

                if (note.fileData && note.fileName) {
                    currentAttachedFileDiv.classList.remove('hidden');
                    attachedFileNameSpan.textContent = note.fileName;
                    removeAttachedFileBtn.onclick = () => {
                        // When removing, set these to null in the note object, but don't save yet.
                        // Saving will happen when the "Guardar Nota" button is clicked.
                        const currentNoteInAppData = appData.notes.find(n => n.id === note.id);
                        if (currentNoteInAppData) {
                            currentNoteInAppData.fileData = null;
                            currentNoteInAppData.fileName = null;
                            currentNoteInAppData.fileType = null;
                        }
                        currentAttachedFileDiv.classList.add('hidden');
                        attachedFileNameSpan.textContent = '';
                    };
                }

            } else {
                noteModalTitle.textContent = 'Añadir Nueva Nota';
                noteIdInput.value = '';
                noteTitleInput.value = '';
                noteContentInput.value = '';
            }
            noteModal.classList.remove('hidden');
        }

        // Cierra el modal de nota
        function closeNoteModal() {
            document.getElementById('noteModal').classList.add('hidden');
        }

        // Añade/Edita una nota
        document.getElementById('saveNoteBtn').addEventListener('click', async () => {
            const noteId = document.getElementById('noteId').value;
            const noteTitle = document.getElementById('noteTitle').value.trim();
            const noteContent = document.getElementById('noteContent').value.trim();
            const noteFileInput = document.getElementById('noteFile');

            if (!noteTitle || !noteContent) {
                showMessage('El título y el contenido de la nota no pueden estar vacíos.', 'error');
                return;
            }

            let fileData = null;
            let fileName = null;
            let fileType = null;

            // If editing, try to get existing file data first
            if (noteId) {
                const existingNote = appData.notes.find(n => n.id === noteId);
                if (existingNote) {
                    fileData = existingNote.fileData;
                    fileName = existingNote.fileName;
                    fileType = existingNote.fileType;
                }
            }


            if (noteFileInput.files.length > 0) {
                const file = noteFileInput.files[0];
                fileName = file.name;
                fileType = file.type;

                // Simple comprobación de tamaño para evitar desbordar localStorage
                if (file.size > 5 * 1024 * 1024) { // 5MB
                    showMessage('El archivo es demasiado grande para guardar localmente. Por favor, adjunta archivos más pequeños.', 'error');
                    return;
                }

                fileData = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    if (fileType.startsWith('text/')) {
                        reader.readAsText(file);
                    } else {
                        reader.readAsDataURL(file); // For all other types, including images, save as Data URL (Base64)
                    }
                });
            }


            if (noteId) {
                const noteIndex = appData.notes.findIndex(n => n.id === noteId);
                if (noteIndex > -1) {
                    appData.notes[noteIndex] = {
                        ...appData.notes[noteIndex],
                        title: noteTitle,
                        content: noteContent,
                        fileData: fileData, // Use the new fileData (can be null if removed or not changed)
                        fileName: fileName,
                        fileType: fileType
                    };
                }
            } else {
                const newNote = {
                    id: crypto.randomUUID(),
                    title: noteTitle,
                    content: noteContent,
                    fileData: fileData,
                    fileName: fileName,
                    fileType: fileType
                };
                appData.notes.push(newNote);
            }
            saveData(appData);
            renderNotes();
            closeNoteModal();
            showMessage('Nota guardada con éxito.', 'success');
        });

        // Event listeners para los botones de nota
        document.getElementById('addNoteBtn').addEventListener('click', () => openNoteModal());
        document.getElementById('cancelNoteBtn').addEventListener('click', closeNoteModal);
        document.getElementById('noteSearch').addEventListener('keyup', renderNotes);


        function addEventListenersToNoteButtons() {
            document.querySelectorAll('.edit-note-btn').forEach(button => {
                button.onclick = (e) => {
                    const noteId = e.target.closest('div[data-id]').dataset.id;
                    const note = appData.notes.find(n => n.id === noteId);
                    if (note) {
                        openNoteModal(note);
                    }
                };
            });

            document.querySelectorAll('.delete-note-btn').forEach(button => {
                button.onclick = (e) => {
                    const noteId = e.target.closest('div[data-id]').dataset.id;
                    showConfirmModal('¿Estás seguro de que quieres eliminar esta nota?', () => {
                        appData.notes = appData.notes.filter(n => n.id !== noteId);
                        saveData(appData);
                        renderNotes();
                        showMessage('Nota eliminada.', 'success');
                    });
                };
            });
        }


        // --- Funcionalidad de Pestañas ---
        const navItems = document.querySelectorAll('.nav-item');
        const tabContents = document.querySelectorAll('.tab-content');

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                // Remove active classes
                navItems.forEach(nav => {
                    nav.classList.remove('active-nav-tab');
                    nav.querySelector('.nav-icon').classList.remove('active');
                });
                tabContents.forEach(content => content.classList.add('hidden'));

                // Add active classes to clicked item
                item.classList.add('active-nav-tab');
                item.querySelector('.nav-icon').classList.add('active');

                // Show corresponding tab content
                const tabId = item.dataset.tab;
                document.getElementById(tabId).classList.remove('hidden');

                // Re-render content when switching tabs to ensure freshness
                if (tabId === 'today' || tabId === 'pending' || tabId === 'history') {
                    renderAllTasks();
                } else if (tabId === 'notes') {
                    renderNotes();
                } else if (tabId === 'calendar') {
                    renderCalendar();
                } else if (tabId === 'progress') {
                    renderProgress();
                }
            });
        });

        // --- Modal de Confirmación Personalizado (en lugar de alert/confirm) ---
        function showConfirmModal(message, onConfirm) {
            let confirmModal = document.getElementById('confirmModal');
            if (!confirmModal) { // Solo crear si no existe
                confirmModal = document.createElement('div');
                confirmModal.id = 'confirmModal';
                confirmModal.classList.add('modal', 'fixed', 'inset-0', 'flex', 'items-center', 'justify-center', 'p-4', 'z-50', 'hidden');
                confirmModal.innerHTML = `
                    <div class="modal-content w-full max-w-sm p-6 space-y-4 text-center">
                        <p id="confirmMessage" class="text-lg font-medium text-gray-700"></p>
                        <div class="flex justify-center space-x-4 mt-6">
                            <button id="confirmCancelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-xl">Cancelar</button>
                            <button id="confirmOkBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-xl">Confirmar</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmModal);
            }

            document.getElementById('confirmMessage').textContent = message;
            confirmModal.classList.remove('hidden');

            const confirmOkBtn = document.getElementById('confirmOkBtn');
            const confirmCancelBtn = document.getElementById('confirmCancelBtn');

            // Asegurarse de que los event listeners se añaden solo una vez por apertura del modal
            const handleConfirm = () => {
                onConfirm();
                confirmModal.classList.add('hidden');
                confirmOkBtn.removeEventListener('click', handleConfirm);
                confirmCancelBtn.removeEventListener('click', handleCancel);
            };

            const handleCancel = () => {
                confirmModal.classList.add('hidden');
                confirmOkBtn.removeEventListener('click', handleConfirm);
                confirmCancelBtn.removeEventListener('click', handleCancel);
            };

            // Remover listeners anteriores antes de añadir nuevos para evitar duplicados
            confirmOkBtn.removeEventListener('click', handleConfirm);
            confirmCancelBtn.removeEventListener('click', handleCancel);

            confirmOkBtn.addEventListener('click', handleConfirm);
            confirmCancelBtn.addEventListener('click', handleCancel);
        }

        // --- Calendar Functionality ---
        let currentCalendarDate = new Date(); // To keep track of the month displayed

        function renderCalendar() {
            const calendarGrid = document.getElementById('calendar-grid');
            const currentMonthYearHeader = document.getElementById('currentMonthYear');
            calendarGrid.innerHTML = ''; // Clear previous calendar

            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth(); // 0-11

            // Set current month and year in header
            currentMonthYearHeader.textContent = new Date(year, month).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

            // Add day names row
            const dayNames = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
            dayNames.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.classList.add('calendar-header-day');
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });

            const firstDayOfMonth = new Date(year, month, 1).getDay(); // Day of week (0-6)
            const daysInMonth = new Date(year, month + 1, 0).getDate(); // Last day of month

            // Add empty cells for days before the 1st of the month
            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.classList.add('calendar-day-cell', 'inactive');
                calendarGrid.appendChild(emptyCell);
            }

            // Add cells for each day of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayCell = document.createElement('div');
                dayCell.classList.add('calendar-day-cell');
                dayCell.dataset.date = date.toISOString().split('T')[0]; // Store date as YYYY-MM-DD

                const dayNumber = document.createElement('span');
                dayNumber.classList.add('day-number');
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);

                // Highlight today's date
                if (date.toDateString() === new Date().toDateString()) {
                    dayCell.classList.add('today');
                }

                // Check for tasks on this day
                const tasksForDay = getTasksForDate(date);
                if (tasksForDay.length > 0) {
                    const taskCountSpan = document.createElement('span');
                    taskCountSpan.classList.add('task-count');
                    taskCountSpan.textContent = tasksForDay.length;
                    dayCell.appendChild(taskCountSpan);
                    dayCell.classList.add('has-tasks'); // Optional: add class for custom styling if needed
                }

                dayCell.addEventListener('click', () => openDayTasksModal(date, tasksForDay));
                calendarGrid.appendChild(dayCell);
            }
        }

        // Helper to get tasks for a specific date
        function getTasksForDate(date) {
            const tasksOnThisDay = [];
            const targetDateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD format

            appData.tasks.forEach(task => {
                if (task.isCompleted) return; // Don't show completed tasks in calendar

                let nextDueDate = null;
                const lastCompleted = task.lastCompleted ? new Date(task.lastCompleted) : null;
                const now = new Date(); // Current date for calculations

                // Recalculate next due date for the purpose of this calendar view
                if (task.frequencyUnit === 'specific_days' && task.daysOfWeek && task.daysOfWeek.length > 0) {
                    let currentSearchDate = lastCompleted ? new Date(lastCompleted) : new Date(now);
                    if (lastCompleted) currentSearchDate.setDate(currentSearchDate.getDate() + 1);

                    for (let i = 0; i < 14; i++) { // Search up to 14 days
                        const dayOfWeek = currentSearchDate.getDay();
                        if (task.daysOfWeek.includes(String(dayOfWeek))) {
                            nextDueDate = new Date(currentSearchDate);
                            break;
                        }
                        currentSearchDate.setDate(currentSearchDate.getDate() + 1);
                    }
                    if (!nextDueDate && !lastCompleted) { // Fallback for never completed tasks
                        let tempDate = new Date(now);
                        for(let i = 0; i < 7; i++) {
                            const dayToCheck = (tempDate.getDay() + i) % 7;
                            if (task.daysOfWeek.includes(String(dayToCheck))) {
                                nextDueDate = new Date(tempDate);
                                nextDueDate.setDate(tempDate.getDate() + i);
                                break;
                            }
                        }
                    }

                } else if (lastCompleted) {
                    nextDueDate = new Date(lastCompleted);
                    if (task.frequencyUnit === 'days') nextDueDate.setDate(nextDueDate.getDate() + task.frequencyValue);
                    else if (task.frequencyUnit === 'weeks') nextDueDate.setDate(nextDueDate.getDate() + (task.frequencyValue * 7));
                    else if (task.frequencyUnit === 'months') nextDueDate.setMonth(nextDueDate.getMonth() + task.frequencyValue);
                    else if (task.frequencyUnit === 'years') nextDueDate.setFullYear(nextDueDate.getFullYear() + task.frequencyValue);
                } else {
                    nextDueDate = now; // If never completed, it's potentially due today
                }

                if (task.postponeUntilDate) {
                    const postponeDate = new Date(task.postponeUntilDate);
                    if (postponeDate > nextDueDate) {
                        nextDueDate = postponeDate;
                    }
                }

                // Check if this task is due on the targetDate
                if (nextDueDate && nextDueDate.toDateString() === date.toDateString()) {
                    tasksOnThisDay.push(task);
                }
            });
            return tasksOnThisDay;
        }

        // Open modal to show tasks for a specific day
        function openDayTasksModal(date, tasks) {
            const modal = document.getElementById('dayTasksModal');
            const title = document.getElementById('dayTasksModalTitle');
            const content = document.getElementById('dayTasksModalContent');

            title.textContent = `Tareas para el ${date.toLocaleDateString('es-ES', { day: '2-digit', month: 'long', year: 'numeric' })}`;
            content.innerHTML = ''; // Clear previous content

            if (tasks.length === 0) {
                content.innerHTML = '<li class="text-center text-gray-500">No hay tareas programadas para este día.</li>';
            } else {
                tasks.forEach(task => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <p class="font-semibold">${task.name}</p>
                        <p class="task-due">${task.description || task.category}</p>
                    `;
                    content.appendChild(li);
                });
            }
            modal.classList.remove('hidden');
        }

        // Close day tasks modal
        document.getElementById('closeDayTasksModalBtn').addEventListener('click', () => {
            document.getElementById('dayTasksModal').classList.add('hidden');
        });


        // Calendar navigation buttons
        document.getElementById('prevMonthBtn').addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        });

        document.getElementById('nextMonthBtn').addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        });


        // --- Progress Functionality ---
        function renderProgress() {
            const totalTasksCreatedSpan = document.getElementById('totalTasksCreated');
            const totalTasksCompletedSpan = document.getElementById('totalTasksCompleted');
            const completionProgressBar = document.getElementById('completionProgressBar');
            const motivationalMessageDiv = document.getElementById('motivationalMessage');

            const totalCreated = appData.tasks.length;
            const totalCompleted = appData.tasks.filter(task => task.isCompleted).length;

            totalTasksCreatedSpan.textContent = totalCreated;
            totalTasksCompletedSpan.textContent = totalCompleted;

            let completionPercentage = 0;
            if (totalCreated > 0) {
                completionPercentage = (totalCompleted / totalCreated) * 100;
            }
            completionProgressBar.style.width = `${completionPercentage.toFixed(0)}%`;
            completionProgressBar.textContent = `${completionPercentage.toFixed(0)}%`;

            // Motivational messages based on percentage
            if (completionPercentage === 100 && totalCreated > 0) {
                motivationalMessageDiv.textContent = "¡Increíble! Has completado todas tus tareas. ¡Sigue así, campeón/a del hogar!";
                motivationalMessageDiv.classList.add('text-green-700');
                motivationalMessageDiv.classList.remove('text-gray-700');
            } else if (completionPercentage >= 75) {
                motivationalMessageDiv.textContent = "¡Excelente progreso! Estás haciendo un trabajo fantástico. ¡Casi lo tienes!";
                motivationalMessageDiv.classList.add('text-green-600');
                motivationalMessageDiv.classList.remove('text-gray-700');
            } else if (completionPercentage >= 50) {
                motivationalMessageDiv.textContent = "¡Buen trabajo! Has llegado a la mitad del camino. ¡Mantén el ritmo!";
                motivationalMessageDiv.classList.remove('text-green-700');
                motivationalMessageDiv.classList.add('text-gray-700');
            } else if (totalCreated > 0 && completionPercentage < 50) {
                motivationalMessageDiv.textContent = "¡Cada tarea cuenta! Un pequeño paso hoy es un gran avance mañana. ¡Tú puedes!";
                motivationalMessageDiv.classList.remove('text-green-700');
                motivationalMessageDiv.classList.add('text-gray-700');
            } else {
                motivationalMessageDiv.textContent = "¡Vamos a empezar a organizar tu hogar! Crea tu primera tarea.";
                motivationalMessageDiv.classList.remove('text-green-700');
                motivationalMessageDiv.classList.add('text-gray-700');
            }
        }


        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            renderAllTasks();
            renderNotes();
            // renderCalendar is called when tab is switched to it.
            // renderProgress is called when tab is switched to it, and also when tasks are completed/deleted.
        });
    </script>
</body>
</html>
